<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-nav { display: flex; gap: 10px; padding: 20px 60px; background: var(--espresso); border-bottom: 2px solid #333; }
        .tab { display: none; padding: 30px 60px; }
        .tab.active { display: block; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #111; border: 1px solid #333; padding: 20px; flex: 1; text-align: center; }
        .stat-card h1 { color: var(--neon-cyan); margin: 0; }
        .list-item { display: flex; justify-content: space-between; align-items: center; background: #111; border: 1px solid #333; padding: 15px; margin-bottom: 10px; transition: 0.2s; }
        .list-item:hover { background: #181818; }
        .danger-zone { margin-top: 50px; border-top: 2px dashed #ff0055; padding-top: 20px; }
        .admin-img { width: 50px; height: 50px; object-fit: cover; border: 1px solid #333; }
    </style>
</head>
<body>
    <div class="scanline-bar"></div>
    <header class="header">
        <div class="logo-area">
            <h1 class="glow-text">ADMIN TERMINAL</h1>
            <p class="flicker-text">Authorized Personnel Only</p>
        </div>
        <div id="clock" style="font-family: monospace; color: var(--neon-cyan);"></div>
    </header>

    <div class="admin-nav">
        <button class="tab-link active" onclick="showTab('live', this)">LIVE_ORDERS</button>
        <button class="tab-link" onclick="showTab('inv', this)">INVENTORY</button>
        <button class="tab-link" onclick="showTab('done', this)">HISTORY_LOG</button>
    </div>

    <div id="live" class="tab active"><div id="live-list"></div></div>
    <div id="inv" class="tab">
        <div class="card" style="text-align: left; margin-bottom: 30px; border-radius: 0;">
            <h2 style="color: var(--latte);">ADD_NEW_ITEM</h2>
            <input id="n" class="terminal-input" placeholder="PRODUCT_NAME">
            <input id="p" class="terminal-input" placeholder="PRICE_PHP">
            <select id="c" class="terminal-input"><option value="coffee">COFFEE</option><option value="snacks">SNACKS</option></select>
            <select id="i" class="terminal-input">
                <option value="" disabled selected>SELECT_IMAGE_FROM_FOLDER</option>
            </select>
            <button onclick="addItem()" class="tab-link" style="color:white; cursor:pointer; width:100%;">UPLOAD_DATA</button>
        </div>
        <div id="product-list-admin"></div>
    </div>

    <div id="done" class="tab">
        <div class="stats-row"><div class="stat-card"><p>TOTAL_REVENUE</p><h1 id="total-revenue">₱0.00</h1></div></div>
        <div id="history-list"></div>
        <div class="danger-zone">
            <button onclick="promptPurge()" style="background: #000; color: #ff0055; border: 1px solid #ff0055; padding: 10px 20px; cursor: pointer; font-weight: bold;">PURGE ALL ORDERS</button>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content" style="border-color:var(--neon-cyan); text-align:center;">
            <h2 id="modalTitle" style="color:var(--neon-cyan);">INFO</h2>
            <div id="modalBody" style="color:white; margin:20px 0; text-align:left; font-family:monospace;"></div>
            <button onclick="closeAdminModal()" style="background:var(--neon-cyan); color:#000; border:none; padding:15px 40px; font-weight:bold; cursor:pointer; width:100%;">ACKNOWLEDGE</button>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content" style="border-color:#ffcc00; text-align:center;">
            <h2 id="confirmTitle" style="color:#ffcc00;">CONFIRM ACTION</h2>
            <p id="confirmMessage" style="color:white; margin:20px 0;"></p>
            
            <input type="password" id="confirmInput" class="terminal-input" style="display:none; text-align:center;" placeholder="ENTER PASSWORD">
            
            <div style="display:flex; gap:10px;">
                <button onclick="closeConfirmModal()" style="flex:1; background:#444; color:white; border:none; padding:15px; cursor:pointer;">CANCEL</button>
                <button id="confirmBtn" style="flex:1; background:#ffcc00; color:#000; border:none; padding:15px; font-weight:bold; cursor:pointer;">CONFIRM</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = `http://${window.location.hostname}:3000`;
        const CORRECT_PASSWORD = "Admin1324@@";

        function summarize(str) {
            if (!str) return "EMPTY";
            const items = str.split(', ');
            const counts = {};
            items.forEach(x => counts[x] = (counts[x] || 0) + 1);
            return Object.entries(counts).map(([name, qty]) => `${qty}x ${name}`).join(', ');
        }

        function showDetails(id, summary, total) {
            const formattedItems = summary.split(', ').map(item => `<li>${item}</li>`).join('');
            const body = `
                <p><strong>ORDER ID:</strong> #${id}</p>
                <p><strong>ITEMS:</strong></p>
                <ul style="margin-left:20px;">${formattedItems}</ul>
                <hr style="border-color:#333;">
                <p><strong>TOTAL:</strong> ₱${total}</p>
            `;
            showAdminModal(`ORDER DETAILS`, body);
        }

        function showTab(id, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            refresh();
        }

        function showAdminModal(title, body) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('adminModal').style.display = 'block';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function showConfirmModal(title, message, onConfirm, showInput = false) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            
            const inputField = document.getElementById('confirmInput');
            if (showInput) {
                inputField.style.display = 'block';
                inputField.value = '';
                inputField.focus();
            } else {
                inputField.style.display = 'none';
            }

            document.getElementById('confirmBtn').onclick = () => {
                onConfirm();
            };
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        async function loadImagesIntoDropdown() {
            try {
                const res = await fetch(`${API_BASE}/api/images`);
                const images = await res.json();
                const dropdown = document.getElementById('i');
                
                dropdown.innerHTML = '<option value="" disabled selected>SELECT_IMAGE_FROM_FOLDER</option>';
                
                images.forEach(image => {
                    let option = document.createElement('option');
                    option.value = 'images/' + image; 
                    option.text = image; 
                    dropdown.appendChild(option);
                });
            } catch (e) {
                console.error("Could not load images", e);
            }
        }

        async function refresh() {
            try {
                // Fetch Live Orders (Oldest first)
                const resL = await fetch(`${API_BASE}/api/orders`);
                const live = await resL.json();
                document.getElementById('live-list').innerHTML = live.map(o => `
                    <div class="list-item" style="border-left: 5px solid red; cursor:pointer;" onclick="showDetails(${o.id}, '${o.items_summary}', '${o.total_amount}')">
                        <div><h3><span class="dot red-blink"></span> ORDER #${o.id}</h3><p style="color:var(--neon-cyan)">${summarize(o.items_summary)}</p></div>
                        <div onclick="event.stopPropagation();">
                            <button onclick="updateStatus(${o.id}, 'Done')" style="background:#00ff00; border:none; padding:10px; font-weight:bold; cursor:pointer;">FINISH</button>
                            <button onclick="updateStatus(${o.id}, 'Canceled')" style="background:#ffcc00; border:none; padding:10px; font-weight:bold; cursor:pointer;">CANCEL</button>
                        </div>
                    </div>`).join('');

                // Fetch History
                const resH = await fetch(`${API_BASE}/api/orders/history`);
                const history = await resH.json();
                let revenue = 0;
                document.getElementById('history-list').innerHTML = history.map(o => {
                    if(o.status === 'Done') revenue += parseFloat(o.total_amount);
                    return `<div class="list-item" style="border-left: 5px solid ${o.status==='Done'?'#00ff00':'#ffcc00'}">
                        <span><span class="dot ${o.status==='Done'?'green-dot':'yellow-dot'}"></span> ORDER #${o.id}</span>
                        <span>${summarize(o.items_summary)} | ₱${o.total_amount}</span>
                    </div>`;
                }).join('');
                document.getElementById('total-revenue').innerText = `₱${revenue.toFixed(2)}`;

                const resI = await fetch(`${API_BASE}/api/items`);
                const items = await resI.json();
                document.getElementById('product-list-admin').innerHTML = items.map(p => `
                    <div class="list-item">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${p.image}" class="admin-img" alt="${p.name}">
                            <span>${p.name} - ₱${p.price}</span>
                        </div>
                        <button onclick="deleteItem(${p.id})" style="background:#ff0055; border:none; color:white; padding:5px; cursor:pointer;">DELETE</button>
                    </div>`).join('');
            } catch (e) { console.log("Server error"); }
        }

        async function updateStatus(id, s) { 
            if (s === 'Canceled') {
                showConfirmModal("CONFIRM CANCEL", `Are you sure you want to cancel ORDER #${id}?`, async () => {
                await fetch(`${API_BASE}/api/orders/status/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:s}) }); 
                refresh();
                closeConfirmModal();
                showAdminModal("SUCCESS", `Order #${id} has been canceled.`);
            });
        } else {
                await fetch(`${API_BASE}/api/orders/status/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:s}) }); 
                refresh(); 
            }
        }
        
        async function addItem() {
            const imgPath = document.getElementById('i').value;
            const name = document.getElementById('n').value;
            const price = document.getElementById('p').value;
            
            if (!imgPath || !name || !price) {
                showAdminModal("ERROR", "Please fill in all fields, including price and image selection.");
                return;
            }

            const data = { 
                name: name, 
                price: price, 
                image: imgPath, 
                category: document.getElementById('c').value 
            };
            
            await fetch(`${API_BASE}/api/add`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) }); 
            
            document.getElementById('n').value = '';
            document.getElementById('p').value = '';
            document.getElementById('i').selectedIndex = 0; 
            
            refresh();
            showAdminModal("SUCCESS", `Item "${name}" added successfully.`);
        }
        
        function deleteItem(id) { 
            showConfirmModal("CONFIRM DELETE", "Are you sure you want to delete this item?", async () => {
                await fetch(`${API_BASE}/api/remove/${id}`, { method:'DELETE' }); 
                refresh(); 
                showAdminModal("SUCCESS", "Item deleted successfully.");
                closeConfirmModal();
            });
        }
        
        function promptPurge() {
            showConfirmModal("ADMIN ACCESS", "ENTER PASSWORD TO PURGE:", async () => {
                const password = document.getElementById('confirmInput').value;
                if (password === CORRECT_PASSWORD) {
                    // Password correct, show final confirmation
                    showConfirmModal("FINAL WARNING", "Are you sure? This will delete all orders and generate a log file.", async () => {
                        const res = await fetch(`${API_BASE}/api/orders/purge`, { method:'DELETE' });
                        const result = await res.json(); 
                        showAdminModal("PURGE COMPLETE", "Log File: " + result.file);
                        refresh();
                        closeConfirmModal();
                    });
                } else {
                    showAdminModal("ERROR", "Incorrect Password.");
                    closeConfirmModal();
                }
            }, true);
        }
        
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
        setInterval(refresh, 2000);

        window.onload = () => {
            refresh();
            loadImagesIntoDropdown();
        };
    </script>
</body>
</html>